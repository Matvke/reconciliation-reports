{% extends "base.html" %}

{% block title %}Акт сверки - {{ store.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="bi bi-file-earmark-text"></i>
                Акт сверки взаиморасчетов
            </h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>Магазин: <strong>{{ store.name }}</strong></h5>
                    {% if store.address %}
                        <p><strong>Адрес:</strong> {{ store.address }}</p>
                    {% endif %}
                    {% if store.phone_number %}
                        <p><strong>Телефон:</strong> {{ store.phone_number }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <h5>Период:</h5>
                    <p>
                        <strong>С:</strong> {{ act.period_start|date:"d.m.Y" }}<br>
                        <strong>По:</strong> {{ act.period_end|date:"d.m.Y" }}
                    </p>
                    <p>
                        <strong>Дата формирования:</strong><br>
                        {{ act.date|date:"d.m.Y H:i" }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center {% if balance_before > 0 %}border-danger{% elif balance_before < 0 %}border-success{% endif %}">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Начальный баланс</h6>
                    <h4 class="card-title {% if balance_before > 0 %}text-danger{% elif balance_before < 0 %}text-success{% endif %}">
                        {{ balance_before|floatformat:2 }} ₽
                    </h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Поставки за период</h6>
                    <h4 class="card-title text-primary">+{{ total_supply|floatformat:2 }} ₽</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Оплаты за период</h6>
                    <h4 class="card-title text-info">-{{ total_transaction|floatformat:2 }} ₽</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center {% if balance_after > 0 %}border-danger{% elif balance_after < 0 %}border-success{% endif %}">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Конечный баланс</h6>
                    <h4 class="card-title {% if balance_after > 0 %}text-danger{% elif balance_after < 0 %}text-success{% endif %}">
                        {{ balance_after|floatformat:2 }} ₽
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">Детализация операций</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Дата</th>
                            <th>Тип операции</th>
                            <th>Поставка (приход)</th>
                            <th>Оплата (расход)</th>
                            <th>Нарастающий баланс</th>
                            <th>Примечание</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events %}
                        <tr>
                            <td>{{ event.date|date:"d.m.Y" }}</td>
                            <td>
                                {% if event.type == 'supply' %}
                                    <span class="badge bg-primary">Поставка</span>
                                {% else %}
                                    <span class="badge bg-info">Оплата</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if event.supply_amount %}
                                    <span class="text-success">+{{ event.supply_amount|floatformat:2 }} ₽</span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if event.transaction_amount %}
                                    <span class="text-danger">-{{ event.transaction_amount|floatformat:2 }} ₽</span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="text-end {% if event.balance > 0 %}text-danger{% elif event.balance < 0 %}text-success{% endif %}">
                                {{ event.balance|floatformat:2 }} ₽
                                {% if event.balance > 0 %}
                                    <small class="text-muted">(долг)</small>
                                {% elif event.balance < 0 %}
                                    <small class="text-muted">(переплата)</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if event.type == 'supply' %}
                                    Поставка №{{ event.supply.id }}
                                {% else %}
                                    Платеж от {{ event.transaction.date|date:"d.m.Y" }}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                За выбранный период операций не найдено
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-4 d-flex justify-content-between">
        <a href="{% url 'act_print' act.pk %}" target="_blank" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Версия для печати
        </a>
        <a href="{% url 'act_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> К списку актов
        </a>
    </div>
</div>

<style>
    @media print {
        .card-header, .btn, .badge {
            background-color: #fff !important;
            color: #000 !important;
            border: 1px solid #000;
        }
        .table {
            border: 1px solid #000;
        }
        .table th, .table td {
            border: 1px solid #000;
        }
    }
    
    .text-success {
        color: #198754 !important;
    }
    .text-danger {
        color: #dc3545 !important;
    }
    .text-primary {
        color: #0d6efd !important;
    }
    .text-info {
        color: #0dcaf0 !important;
    }
</style>
{% endblock %}